##Сравнение Redis, Tarantool и Memcached в Microsoft Azure

Tarantool – NoSQL СУБД, которая разрабатывается и широко используется в Mail.Ru. Об объемах использования можно сделать вывод по публикациям:
-	Под высокой нагрузкой: наши способы применения Tarantool ( [https://habrahabr.ru/company/mailru/blog/279999/](https://habrahabr.ru/company/mailru/blog/279999/) )
-	Asyncio Tarantool Queue, вставай в очередь ( [https://habrahabr.ru/company/mailru/blog/271513/](https://habrahabr.ru/company/mailru/blog/271513/) )
Недавно mail.ru выпустила виртуальную машину с предустановленным Tarantool для Microsoft Azure:
-	[https://azure.microsoft.com/en-us/marketplace/partners/my-com/tarantool/](https://azure.microsoft.com/en-us/marketplace/partners/my-com/tarantool/)
-	[https://habrahabr.ru/company/microsoft/blog/279845/](https://habrahabr.ru/company/microsoft/blog/279845/)
Мы решили проверить, насколько хорошо Tarantool работает в Microsoft Azure в сравнении с другими решениями – Azure Redis Cache и Bitnami Memcached. Под словом «хорошо» будем понимать «быстро», то есть сравнивать будем число обрабатываемых запросов в секунду (Throughput, RPS).

**Redis Cache**
Нам потребуется инстанс Redis Cache уровня «Базовый C4» (13 Гб), в котором мы включаем не-SSL порт (для честного сравнения SSL нам не требуется). Использовать именно «Базовый» уровень нужно для того, чтобы исключить репликацию.
Azure Redis Cache предоставляется как сервис и доступа к виртуальной машине мы не имеем. Мы не знаем, как он настроен  не можем на это повлиять.
Ориентировочная стоимость Redis Cache нашего размера 9765 рублей в месяц.

**Tarantool VM**
Нам потребуется одна виртуальная машина Tarantool VM Standard D11 с 14 Гб с HDD-дисками. Данная конфигурации обойдется нам в 9067 рублей в месяц.
Мы будем тестировать Tarantool в двух режимах: с включенным write-ahead log (для персистентности данных) и с выключенным, так как мы не знаем достоверно, включена ли соответствующая настройка у Redis.
*Для смены режима записи в /etc/tarantool/instances.enabled/example.lua меняем настройку wal_mode (‘none’ для работы без WAL, ‘write’ – с WAL, ‘fsync’ – весьма специфичный режим работы, который тестировать не будем).*
Мы использовали HASH-индекс. Tarantool, в отличие от Redis и Memcached, имеет TREE-индексы, однако, нам нужно сравнивать равное с равным.

**Memcached**
Мы использовали образ виртуальной машины с предустановленным Memcached от Bitnami.
*В Azure Marketplace есть и другой Memcached – облачный сервис от Redis Labs, однако доступен он только на территории США, и протестировать его не получилось.*
После развертывания виртуальной машины мы отключили авторизацию в конфигурационном файле memcached.conf (опция –S). Memcached не умеет обеспечивать персистентность данных.

**Синхронно-асинхронный тест**
Исходник тут: [https://gist.github.com/rvncerr/3b4abf65e07794ca3345](https://gist.github.com/rvncerr/3b4abf65e07794ca3345)
Мы попробуем провести «синхронно-асинхронный» тест, то есть интерфейс у нас будет синхронный, но внутри с соединением будем работать асинхронным образом. Этот вид теста позволяет имитировать работу через одно соединение для множества синхронных клиентов.
Чтобы исключить сомнения в идентичности теста для Redis Cache, Tarantool VM и Memcached, всю общую логику вынесем в абстрактный класс NoSQLConnection, от которого потом отнаследуем TarantoolConnection, RedisConnection и MemcachedConnection (см. исходник).
В классе есть две очереди (обычные std::list) – OutputQueue (будет отправлено в сокет) и InputQueue (принятое из сокета), а также методы SendThreadFunc и ReceiveThreadFunc, которые запускаются в отдельных потоках и, при наличии соответствующих непустых очередей, отправляют/принимают информацию пачкой с помощью методов Send и Receive (чистые виртуальные, реализованы в наследниках).
Синхронный интерфейс представлен методом DoSyncQuery, который кладет запрос в OutputQueue и ждет ответа в InputQueue.
Тестовая виртуалка должна быть достаточно мощной (Standard D3) и находиться географически рядом с базой данных (мы использовали расположение "Западный регион США").
В диапазоне до 10 потоков с шагом в 1 мы близки к полностью синхронному режиму работы (а 1 поток по сути им и является). На графике наблюдается более-менее линейный рост. Redis и Memcached дают примерно равную производительность, Tarantool быстрее.
![1](http://image.prntscr.com/image/26accea4e8384ec9bac862d9c576ed17.png)
 ![2](http://image.prntscr.com/image/e19fb98d12c44d6796611adc2d759fcf.png)
 
Следующий график – до 100 потоков с шагом в 10, линейный рост продолжается:
![3](http://image.prntscr.com/image/d4380f793a984a61ad76e190ba524357.png)
 
 

Далее идем до 1000 с шагом в 100 потоков. Рост замедляется, а для Memcached и вовсе останавливается.
![4](http://image.prntscr.com/image/956748b5e9a54e659610ff5114cadb99.png)
 

И, наконец, идем до 8000 потоков с шагом 1000. Рост прекращается. После 4000 клиентов Memcached перестает работать – закрывает соединение – поэтому протестировать его не удается.
![5](http://image.prntscr.com/image/451df34e239e4b08a5148ef84f5a886e.png)
 
 

**А что с синхронным тестом?**
А тут все просто. Запускаем синхронно-асинхронный тест в 1 поток и он очевидным образом становится просто синхронным. Но если клиентов много, то потребуется много соединений… Хорошо, тогда запустим несколько тестов параллельно и просуммируем результаты.
![6](http://image.prntscr.com/image/fa2e8f1ecb92410d8fc858200d127bec.png)
 
 

Мы видим, что синхронный тест имеет определенный «потолок», который ниже, чем у синхронно-асинхронного соединения. Этот потолок вызван накладными расходами на сеть.

**Сравнение цен**
Сами Tarantool и Memcached бесплатны, оплачивать нужно только виртуальную машину, на которой они запущены. Мы использовали Standard D11 (14 Гб оперативной памяти), который стоит ~9067 рублей в месяц.
Redis Cache стоит дороже – ~9765 рублей в месяц за Базовый C3 инстанс (13 Гб оперативной памяти).
Визуализируем:
![7](http://image.prntscr.com/image/86878ebb2d634daeadb73ee3400e05c9.png)
 

В плане месячной цены отличия небольшие, однако, как мы видели ранее, эти базы данных имеют разную производительность. Попробуем выразить стоимость не в месяц, а на миллиард запросов. 

Сперва посмотрим, сколько стоит миллиард запросов записи при 1000 клиентах.
![8](http://image.prntscr.com/image/4965886ab10841afac342a53be17a029.png)
 

Memcached – явный аутсайдер, посмотрим на остальных кандидатов вблизи.
![9](http://image.prntscr.com/image/5b305f3d742041b0a48fa29677775855.png)
 

А теперь, как изменится стоимость, если считать запросы на чтение на 100 клиентах.
![enter image description here](http://image.prntscr.com/image/a919b850832b426393960f53bf370f91.png)
 

**Выводы**
В процессе тестирования тестовый процесс в синхронно-асинхронном тесте вызывал нагрузку на процесс tarantool до 70% CPU, в синхронном режиме – до 100%.

На всех графиках Tarantool VM, вне зависимости от режима WAL, показал себя лучше Redis Cache и Bitnami Memcached. Заметим, что наличие или отсутствие WAL не влияет на скорость чтения из Tarantool (на графиках чтения оранжевая и серая кривые совпадают), так как при чтении из Tarantool диск не используется.

Кроме того, Tarantool VM оказался самым дешевым решением как на единицу времени (в месяц) так и на каждый запрос.


